╔══════════════════════════════════════════════════════════════════════════════╗
║                    FESTA EVALUATION SYSTEM - VISUAL DIAGRAMS                  ║
╚══════════════════════════════════════════════════════════════════════════════╝

═══════════════════════════════════════════════════════════════════════════════
DIAGRAM 1: HIGH-LEVEL SYSTEM ARCHITECTURE
═══════════════════════════════════════════════════════════════════════════════

                         ┌──────────────────────────┐
                         │   BLINK Spatial Dataset  │
                         │   (143 samples total)    │
                         └───────────┬──────────────┘
                                     │
                                     ▼
            ┌────────────────────────────────────────────────┐
            │         FESTA Evaluation System                │
            │                                                │
            │  ┌──────────────────────────────────────────┐ │
            │  │  Sample Processing Engine                │ │
            │  │  • Configurable: NUM_SAMPLES=2 or 143    │ │
            │  │  • Parallel support via SKIP_SAMPLES     │ │
            │  └────────────┬─────────────────────────────┘ │
            │               │                                │
            │               ▼                                │
            │  ┌──────────────────────────────────────────┐ │
            │  │  Complement Generator (FES/FCS)          │ │
            │  │  ┌────────────────┐  ┌────────────────┐  │ │
            │  │  │  OpenAI API    │  │  Gemini Pro    │  │ │
            │  │  │  (Text)        │  │  (Image)       │  │ │
            │  │  └────────────────┘  └────────────────┘  │ │
            │  └────────────┬─────────────────────────────┘ │
            │               │                                │
            │               ▼                                │
            │  ┌──────────────────────────────────────────┐ │
            │  │  LLaVA Inference Engine                  │ │
            │  │  • Probability-based top-k inference     │ │
            │  │  • GPU-accelerated (CUDA)                │ │
            │  │  • 4-bit quantization                    │ │
            │  └────────────┬─────────────────────────────┘ │
            │               │                                │
            │               ▼                                │
            │  ┌──────────────────────────────────────────┐ │
            │  │  Metrics Calculator & Visualizer         │ │
            │  │  • 10+ metrics (AUROC, Precision, etc.)  │ │
            │  │  • 6+ visualizations                     │ │
            │  └────────────┬─────────────────────────────┘ │
            └───────────────┼────────────────────────────────┘
                            │
                            ▼
            ┌───────────────────────────────────────────────┐
            │         Output & Reports                      │
            │  • JSON results                               │
            │  • Markdown summaries                         │
            │  • CSV exports                                │
            │  • PNG visualizations                         │
            └───────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════
DIAGRAM 2: SAMPLE PROCESSING FLOW (Single Sample - e.g., Sample 31)
═══════════════════════════════════════════════════════════════════════════════

START: Sample 31 from BLINK Dataset
│
├─ Question: "Is the apple left of the banana?"
├─ Image: [apple] [banana]
├─ Ground Truth: "A" (yes)
│
└─► STEP 1: ORIGINAL INFERENCE
    ═══════════════════════════════════════════════════════════════════
    │
    │   ┌─────────────────────────────────────────────────────────┐
    │   │  LLaVA Model (GPU)                                      │
    │   │  ─────────────────                                      │
    │   │  Input:  Image + Question                              │
    │   │          ↓                                              │
    │   │  run_topk_inference(k=4, n_samples=5)                 │
    │   │          ↓                                              │
    │   │  Generate 20 predictions (4 positions × 5 samples)     │
    │   │          ↓                                              │
    │   │  Combine via weighted voting                           │
    │   │          ↓                                              │
    │   │  Output: Prediction="A", Confidence=0.82              │
    │   └─────────────────────────────────────────────────────────┘
    │
    └─► RESULT: ✓ Correct (A == A)
    │
    │
    └─► STEP 2: GENERATE FES TEXT (Semantic Paraphrases)
        ═══════════════════════════════════════════════════════════
        │
        │   ┌─────────────────────────────────────────────────────┐
        │   │  OpenAI GPT-4o-mini API                            │
        │   │  ───────────────────────                           │
        │   │  Input:  "Is the apple left of the banana?"       │
        │   │          ↓                                          │
        │   │  Prompt: "Generate 5 semantic paraphrases"        │
        │   │          ↓                                          │
        │   │  Output:                                           │
        │   │    1. "Is the apple positioned to the left?"      │
        │   │    2. "Does the apple appear on the left side?"   │
        │   │    3. "Is the apple located left of the banana?"  │
        │   │    4. "Can you see the apple to the left?"        │
        │   │    5. "Is the apple's position leftward?"         │
        │   └─────────────────────────────────────────────────────┘
        │
        │   For each paraphrase (1-5):
        │   ┌─────────────────────────────────────────────────────┐
        │   │  LLaVA Inference                                   │
        │   │  ────────────────                                  │
        │   │  Input: Original Image + Paraphrased Question     │
        │   │         ↓                                          │
        │   │  Expected: Same prediction (A)                    │
        │   │         ↓                                          │
        │   │  Actual Results:                                  │
        │   │    Paraphrase 1: A (conf: 0.79) ✓                │
        │   │    Paraphrase 2: A (conf: 0.81) ✓                │
        │   │    Paraphrase 3: A (conf: 0.83) ✓                │
        │   │    Paraphrase 4: A (conf: 0.80) ✓                │
        │   │    Paraphrase 5: A (conf: 0.78) ✓                │
        │   └─────────────────────────────────────────────────────┘
        │
        └─► FES Text Consistency: 5/5 = 100% ✓
        │
        │
        └─► STEP 3: GENERATE FCS TEXT (Contradictions)
            ═══════════════════════════════════════════════════════
            │
            │   ┌─────────────────────────────────────────────────┐
            │   │  OpenAI GPT-4o-mini API                        │
            │   │  ───────────────────────                       │
            │   │  Input:  "Is the apple left of the banana?"   │
            │   │          ↓                                      │
            │   │  Prompt: "Generate 5 contradictory questions" │
            │   │          ↓                                      │
            │   │  Output:                                       │
            │   │    1. "Is the apple right of the banana?"     │
            │   │    2. "Is the banana left of the apple?"      │
            │   │    3. "Is the apple to the right?"            │
            │   │    4. "Does the banana appear left?"          │
            │   │    5. "Is the apple rightward?"               │
            │   └─────────────────────────────────────────────────┘
            │
            │   [21-second delay for API rate limits]
            │
            │   For each contradiction (1-5):
            │   ┌─────────────────────────────────────────────────┐
            │   │  LLaVA Inference                               │
            │   │  ────────────────                              │
            │   │  Input: Original Image + Contradictory Q      │
            │   │         ↓                                      │
            │   │  Expected: Opposite prediction (B)            │
            │   │         ↓                                      │
            │   │  Actual Results:                              │
            │   │    Contradiction 1: B (conf: 0.75) ✓          │
            │   │    Contradiction 2: B (conf: 0.77) ✓          │
            │   │    Contradiction 3: B (conf: 0.73) ✓          │
            │   │    Contradiction 4: B (conf: 0.76) ✓          │
            │   │    Contradiction 5: B (conf: 0.74) ✓          │
            │   └─────────────────────────────────────────────────┘
            │
            └─► FCS Text Discrimination: 5/5 = 100% ✓
            │
            │
            └─► STEP 4: GENERATE FES IMAGE (Meaning-Preserving)
                ═══════════════════════════════════════════════════
                │
                │   ┌──────────────────────────────────────────────┐
                │   │  PIL Image Processing (LOCAL)               │
                │   │  ────────────────────────────────           │
                │   │  Input: Image + Question                   │
                │   │         ↓                                   │
                │   │  PIL Transformations (meaning-preserving): │
                │   │    1. Gaussian noise (σ=0.01)              │
                │   │    2. Gaussian blur (σ=0.5)                │
                │   │    3. Contrast adjustment (1.05)           │
                │   │    4. Brightness adjustment (1.02)         │
                │   │    5. Grayscale or dotted masking          │
                │   │                                             │
                │   │  Note: No API calls - all local processing │
                │   └──────────────────────────────────────────────┘
                │
                │   For each transformed image (1-5):
                │   ┌──────────────────────────────────────────────┐
                │   │  LLaVA Inference                            │
                │   │  ────────────────                           │
                │   │  Input: Transformed Image + Original Q     │
                │   │         ↓                                   │
                │   │  Expected: Same prediction (A)             │
                │   │         ↓                                   │
                │   │  Actual Results:                           │
                │   │    FES Image 1: A (conf: 0.78) ✓           │
                │   │    FES Image 2: A (conf: 0.80) ✓           │
                │   │    FES Image 3: A (conf: 0.76) ✓           │
                │   │    FES Image 4: A (conf: 0.79) ✓           │
                │   │    FES Image 5: A (conf: 0.77) ✓           │
                │   └──────────────────────────────────────────────┘
                │
                └─► FES Image Consistency: 5/5 = 100% ✓
                │
                │
                └─► STEP 5: GENERATE FCS IMAGE (Meaning-Altering)
                    ═══════════════════════════════════════════════
                    │
                    │   ┌──────────────────────────────────────────┐
                    │   │  PIL Image Processing (LOCAL)           │
                    │   │  ────────────────────────────────       │
                    │   │  Input: Image + Question               │
                    │   │         ↓                               │
                    │   │  PIL Transformations (meaning-altering):│
                    │   │    1. Horizontal flip/mirror (left↔right)│
                    │   │    2. Vertical flip (above↔below)      │
                    │   │    3. Rotation 180° (both axes)        │
                    │   │  Plus: Subtle photometric adjustments  │
                    │   │                                         │
                    │   │  Note: No API calls - all local processing│
                    │   └──────────────────────────────────────────┘
                    │
                    │   For each transformed image (1-3):
                    │   ┌──────────────────────────────────────────┐
                    │   │  LLaVA Inference                        │
                    │   │  ────────────────                       │
                    │   │  Input: Transformed Image + Original Q │
                    │   │         ↓                               │
                    │   │  Expected: Opposite prediction (B)     │
                    │   │         ↓                               │
                    │   │  Actual Results:                       │
                    │   │    FCS Image 1: B (conf: 0.72) ✓       │
                    │   │    FCS Image 2: B (conf: 0.74) ✓       │
                    │   │    FCS Image 3: B (conf: 0.71) ✓       │
                    │   └──────────────────────────────────────────┘
                    │
                    └─► FCS Image Discrimination: 3/3 = 100% ✓

SUMMARY FOR SAMPLE 31:
═════════════════════════════════════════════════════════════════
│
├─ Original Prediction: A (Confidence: 0.82) ✓
├─ FES Text Generated: 5 samples (5/5 consistent)
├─ FCS Text Generated: 5 samples (5/5 discriminated)
├─ FES Image Generated: 5 samples (5/5 consistent)
├─ FCS Image Generated: 3 samples (3/3 discriminated)
│
└─ Total Predictions for Sample 31: 1 + 5 + 5 + 5 + 3 = 19


═══════════════════════════════════════════════════════════════════════════════
DIAGRAM 3: MODEL ECOSYSTEM AND DATA FLOW
═══════════════════════════════════════════════════════════════════════════════

                    ┌───────────────────────────────────┐
                    │  EXTERNAL APIs (Cloud Services)   │
                    ├───────────────────────────────────┤
                    │                                   │
                    │  ┌─────────────────────────────┐  │
                    │  │  OpenAI GPT-4o-mini         │  │
                    │  │  ─────────────────────      │  │
                    │  │  • Text paraphrasing (FES)  │  │
                    │  │  • Text contradiction (FCS) │  │
                    │  │  • Rate: 3 req/min          │  │
                    │  └─────────────────────────────┘  │
                    │              ↕                     │
                    │              │ REST API            │
                    │              ↕                     │
                    │  ┌─────────────────────────────┐  │
                    │  │  Google Gemini Pro          │  │
                    │  │  ─────────────────          │  │
                    │  │  • Status: CONFIGURED       │  │
                    │  │  • NOT actively used        │  │
                    │  │  • Reserved for future      │  │
                    │  └─────────────────────────────┘  │
                    │                                   │
                    └──────────────┬────────────────────┘
                                   │
                                   │ API Calls (21s delay)
                                   │
                                   ▼
        ┌──────────────────────────────────────────────────────┐
        │  FESTA EVALUATION SYSTEM (Local/GPU Server)          │
        ├──────────────────────────────────────────────────────┤
        │                                                       │
        │  ┌────────────────────────────────────────────────┐  │
        │  │  Complement Generator Module                   │  │
        │  │  ────────────────────────────                  │  │
        │  │  • Coordinates API calls (OpenAI only)         │  │
        │  │  • Manages rate limiting (21-sec delay)        │  │
        │  │  • Saves generated samples                     │  │
        │  │                                                 │  │
        │  │  Components:                                    │  │
        │  │  • GPT4TextTransformer (OpenAI API)           │  │
        │  │  • GeminiImageTransformer (wrapper for PIL)    │  │
        │  │  • PIL for all image operations (LOCAL)        │  │
        │  └────────────────────────────────────────────────┘  │
        │                          │                            │
        │                          ▼                            │
        │  ┌────────────────────────────────────────────────┐  │
        │  │  LLaVA Model (Primary Evaluation Target)       │  │
        │  │  ────────────────────────────────────          │  │
        │  │  Model: llava-v1.6-mistral-7b-hf              │  │
        │  │  Device: CUDA (GPU)                            │  │
        │  │  Optimization: 4-bit quantization              │  │
        │  │                                                 │  │
        │  │  ┌──────────────────────────────────────────┐  │  │
        │  │  │  run_topk_inference()                    │  │  │
        │  │  │  ─────────────────────                   │  │  │
        │  │  │  Input:                                  │  │  │
        │  │  │    • PIL.Image object                    │  │  │
        │  │  │    • Question string                     │  │  │
        │  │  │    • Options dict {A, B}                 │  │  │
        │  │  │    • k=4 (top-k positions)               │  │  │
        │  │  │    • n_samples=5 (per position)          │  │  │
        │  │  │                                          │  │  │
        │  │  │  Process:                                │  │  │
        │  │  │    1. Format probability-based prompt   │  │  │
        │  │  │    2. Apply chat template               │  │  │
        │  │  │    3. Generate with temp=0.7            │  │  │
        │  │  │    4. Parse: "G1: A\nP1: 0.85"          │  │  │
        │  │  │    5. Repeat n_samples times            │  │  │
        │  │  │    6. Return list of (guess, prob)      │  │  │
        │  │  │                                          │  │  │
        │  │  │  Output:                                 │  │  │
        │  │  │    [(A, 0.85), (A, 0.82), ...]          │  │  │
        │  │  └──────────────────────────────────────────┘  │  │
        │  │                          │                      │  │
        │  │                          ▼                      │  │
        │  │  ┌──────────────────────────────────────────┐  │  │
        │  │  │  get_combined_pred()                     │  │  │
        │  │  │  ────────────────────                    │  │  │
        │  │  │  • Vote by frequency                     │  │  │
        │  │  │  • Weight by confidence                  │  │  │
        │  │  │  • Return: (prediction, confidence)      │  │  │
        │  │  └──────────────────────────────────────────┘  │  │
        │  └────────────────────────────────────────────────┘  │
        │                          │                            │
        │                          ▼                            │
        │  ┌────────────────────────────────────────────────┐  │
        │  │  Metrics & Visualization Module                │  │
        │  │  ────────────────────────────────             │  │
        │  │                                                 │  │
        │  │  ┌──────────────────────────────────────────┐  │  │
        │  │  │  FESTAMetrics                            │  │  │
        │  │  │  ────────────                            │  │  │
        │  │  │  • calculate_comprehensive_metrics()     │  │  │
        │  │  │    - AUROC, AUPRC                        │  │  │
        │  │  │    - Precision, Recall, F1               │  │  │
        │  │  │    - Brier Score, ECE                    │  │  │
        │  │  │    - FES Consistency                     │  │  │
        │  │  │    - FCS Discrimination                  │  │  │
        │  │  └──────────────────────────────────────────┘  │  │
        │  │                                                 │  │
        │  │  ┌──────────────────────────────────────────┐  │  │
        │  │  │  FESTAVisualizer                         │  │  │
        │  │  │  ───────────────                         │  │  │
        │  │  │  • plot_roc_curve()                      │  │  │
        │  │  │  • plot_precision_recall_curve()         │  │  │
        │  │  │  • plot_risk_coverage_curve()            │  │  │
        │  │  │  • plot_accuracy_coverage_curve()        │  │  │
        │  │  │  • plot_confidence_distribution()        │  │  │
        │  │  │  • plot_calibration()                    │  │  │
        │  │  └──────────────────────────────────────────┘  │  │
        │  └────────────────────────────────────────────────┘  │
        │                          │                            │
        │                          ▼                            │
        │  ┌────────────────────────────────────────────────┐  │
        │  │  Export & Reporting                            │  │
        │  │  ──────────────────                            │  │
        │  │  • JSON export                                 │  │
        │  │  • Markdown reports                            │  │
        │  │  • CSV export                                  │  │
        │  │  • PNG visualizations                          │  │
        │  └────────────────────────────────────────────────┘  │
        │                                                       │
        └───────────────────────────────────────────────────────┘
                                   │
                                   ▼
                    ┌─────────────────────────────┐
                    │  OUTPUT DIRECTORY STRUCTURE │
                    ├─────────────────────────────┤
                    │                             │
                    │  output/                    │
                    │  ├── api_run/               │
                    │  │   ├── *.json             │
                    │  │   ├── *.md               │
                    │  │   └── generated_samples/ │
                    │  │       ├── *.png          │
                    │  │       └── *.json         │
                    │  └── metrics/               │
                    │      └── *.png              │
                    │                             │
                    │  reports/                   │
                    │  └── festa_report_*.json    │
                    │                             │
                    └─────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════
DIAGRAM 4: METRICS CALCULATION FLOW
═══════════════════════════════════════════════════════════════════════════════

PHASE 1: DATA COLLECTION
════════════════════════════════════════════════════════════════════

    Original Samples (N=2)
    ──────────────────────
    Sample 31: pred=A, gt=A, conf=0.82 ✓
    Sample 32: pred=B, gt=B, conf=0.78 ✓
                    │
                    ▼
    ┌──────────────────────────────────────────────────────────────┐
    │  Collect predictions: y_true_orig, y_pred_orig, y_scores_orig│
    │  y_true_orig  = [1, 0]  (1=A, 0=B)                           │
    │  y_pred_orig  = [1, 0]                                       │
    │  y_scores_orig = [0.82, 0.78]                                │
    └──────────────────────────────────────────────────────────────┘
                    │
                    ▼

    FES Text Samples (N×5 = 10)
    ───────────────────────────
    Sample 31 FES Text 1-5: All pred=A (consistency ✓)
    Sample 32 FES Text 1-5: All pred=B (consistency ✓)
                    │
                    ▼
    ┌──────────────────────────────────────────────────────────────┐
    │  Add to arrays: y_true_all, y_pred_all, y_scores_all        │
    │  (Ground truth same as original for FES)                     │
    └──────────────────────────────────────────────────────────────┘
                    │
                    ▼

    FCS Text Samples (N×5 = 10)
    ───────────────────────────
    Sample 31 FCS Text 1-5: All pred=B (discrimination ✓)
    Sample 32 FCS Text 1-5: All pred=A (discrimination ✓)
                    │
                    ▼
    ┌──────────────────────────────────────────────────────────────┐
    │  Add to arrays: y_true_all, y_pred_all, y_scores_all        │
    │  (Ground truth FLIPPED for FCS: A→B, B→A)                   │
    └──────────────────────────────────────────────────────────────┘
                    │
                    ▼

    FES Image Samples (N×5 = 10)
    ────────────────────────────
    Sample 31 FES Image 1-5: All pred=A (consistency ✓)
    Sample 32 FES Image 1-5: All pred=B (consistency ✓)
                    │
                    ▼
    ┌──────────────────────────────────────────────────────────────┐
    │  Add to arrays (ground truth same as original)               │
    └──────────────────────────────────────────────────────────────┘
                    │
                    ▼

    FCS Image Samples (N×3 = 6)
    ───────────────────────────
    Sample 31 FCS Image 1-3: All pred=B (discrimination ✓)
    Sample 32 FCS Image 1-3: All pred=A (discrimination ✓)
                    │
                    ▼
    ┌──────────────────────────────────────────────────────────────┐
    │  Add to arrays (ground truth FLIPPED)                        │
    └──────────────────────────────────────────────────────────────┘
                    │
                    ▼

TOTAL: y_true_all, y_pred_all, y_scores_all
       Length = N × (1 + 5 + 5 + 5 + 3) = N × 19
       For N=2: 38 total predictions


PHASE 2: METRICS CALCULATION
════════════════════════════════════════════════════════════════════

    ┌────────────────────────────────────────────────────────────┐
    │  1. AUROC (Area Under ROC Curve)                           │
    │  ═══════════════════════════════════                       │
    │                                                             │
    │  from sklearn.metrics import roc_auc_score                 │
    │  auroc = roc_auc_score(y_true_all, y_scores_all)          │
    │                                                             │
    │  Requirements:                                              │
    │  • At least 2 classes in y_true_all                        │
    │  • Probability scores (not just binary predictions)        │
    │                                                             │
    │  Example:                                                   │
    │  y_true_all  = [1,1,1,1,1,0,0,0,0,0,1,1,0,0,...]          │
    │  y_scores_all = [0.82,0.79,0.81,0.83,0.80,0.75,...]       │
    │                                                             │
    │  Process:                                                   │
    │  1. Sort all samples by confidence score                   │
    │  2. For each threshold:                                    │
    │     • Calculate TPR (True Positive Rate)                   │
    │     • Calculate FPR (False Positive Rate)                  │
    │  3. Plot ROC curve (FPR vs TPR)                            │
    │  4. Calculate area under curve                             │
    │                                                             │
    │  Result: AUROC = 0.78 ✓ (Target: ≥ 0.7)                   │
    └────────────────────────────────────────────────────────────┘
              │
              ▼
    ┌────────────────────────────────────────────────────────────┐
    │  2. ACCURACY                                                │
    │  ═══════════                                                │
    │                                                             │
    │  from sklearn.metrics import accuracy_score                │
    │                                                             │
    │  accuracy_orig = accuracy_score(y_true_orig, y_pred_orig)  │
    │  accuracy_all  = accuracy_score(y_true_all, y_pred_all)   │
    │                                                             │
    │  Example:                                                   │
    │  Original: 2/2 = 100%                                      │
    │  All:     36/38 = 94.7%                                    │
    └────────────────────────────────────────────────────────────┘
              │
              ▼
    ┌────────────────────────────────────────────────────────────┐
    │  3. PRECISION, RECALL, F1-SCORE                            │
    │  ══════════════════════════════════                        │
    │                                                             │
    │  from sklearn.metrics import precision_recall_fscore_...   │
    │                                                             │
    │  precision, recall, f1, _ = precision_recall_fscore_...()  │
    │                                                             │
    │  Confusion Matrix:                                          │
    │                 Predicted                                   │
    │              A (pos)  B (neg)                               │
    │  Actual  A    18       1      (19 total A)                 │
    │          B     1      18      (19 total B)                 │
    │                                                             │
    │  Precision = TP / (TP + FP) = 18 / (18 + 1) = 0.947       │
    │  Recall    = TP / (TP + FN) = 18 / (18 + 1) = 0.947       │
    │  F1        = 2×(P×R)/(P+R)  = 0.947                       │
    └────────────────────────────────────────────────────────────┘
              │
              ▼
    ┌────────────────────────────────────────────────────────────┐
    │  4. AUPRC (Area Under Precision-Recall Curve)              │
    │  ════════════════════════════════════════════              │
    │                                                             │
    │  from sklearn.metrics import average_precision_score       │
    │  auprc = average_precision_score(y_true_all, y_scores_all) │
    │                                                             │
    │  Similar to AUROC but for precision-recall trade-off       │
    │  Better for imbalanced datasets                            │
    └────────────────────────────────────────────────────────────┘
              │
              ▼
    ┌────────────────────────────────────────────────────────────┐
    │  5. BRIER SCORE                                             │
    │  ══════════════                                             │
    │                                                             │
    │  from sklearn.metrics import brier_score_loss              │
    │  brier = brier_score_loss(y_true_all, y_scores_all)       │
    │                                                             │
    │  Formula: (1/N) × Σ(predicted_prob - actual)²             │
    │                                                             │
    │  Measures calibration quality                              │
    │  Lower is better (0.0 = perfect)                           │
    └────────────────────────────────────────────────────────────┘
              │
              ▼
    ┌────────────────────────────────────────────────────────────┐
    │  6. ECE (Expected Calibration Error)                        │
    │  ═══════════════════════════════════                        │
    │                                                             │
    │  Custom calculation:                                        │
    │  1. Divide [0, 1] into 10 bins: [0-0.1, 0.1-0.2, ...]     │
    │  2. For each bin:                                          │
    │     • Find predictions in bin                              │
    │     • Calculate average confidence                         │
    │     • Calculate actual accuracy                            │
    │     • Error = |avg_conf - accuracy|                        │
    │  3. Weighted average by bin size                           │
    │                                                             │
    │  Example:                                                   │
    │  Bin [0.7-0.8]: avg_conf=0.75, accuracy=0.72              │
    │  Error = |0.75 - 0.72| = 0.03                             │
    │                                                             │
    │  Result: ECE = 0.045 (well calibrated)                    │
    └────────────────────────────────────────────────────────────┘
              │
              ▼
    ┌────────────────────────────────────────────────────────────┐
    │  7. FES CONSISTENCY (FESTA-specific)                        │
    │  ═══════════════════════════════                            │
    │                                                             │
    │  For each original sample:                                  │
    │    • Compare original prediction with FES predictions      │
    │    • Count matches                                         │
    │                                                             │
    │  Sample 31: orig=A, FES=[A,A,A,A,A] → 5/5 = 100%          │
    │  Sample 32: orig=B, FES=[B,B,B,B,B] → 5/5 = 100%          │
    │                                                             │
    │  Overall FES Consistency: 10/10 = 100% ✓                   │
    └────────────────────────────────────────────────────────────┘
              │
              ▼
    ┌────────────────────────────────────────────────────────────┐
    │  8. FCS DISCRIMINATION (FESTA-specific)                     │
    │  ══════════════════════════════════                         │
    │                                                             │
    │  For each original sample:                                  │
    │    • Compare original prediction with FCS predictions      │
    │    • Count opposites (A→B or B→A)                         │
    │                                                             │
    │  Sample 31: orig=A, FCS=[B,B,B,B,B] → 5/5 = 100%          │
    │  Sample 32: orig=B, FCS=[A,A,A,A,A] → 5/5 = 100%          │
    │                                                             │
    │  Overall FCS Discrimination: 10/10 = 100% ✓                │
    └────────────────────────────────────────────────────────────┘


PHASE 3: VISUALIZATION GENERATION
════════════════════════════════════════════════════════════════════

    ┌────────────────────────────────────────────────────────────┐
    │  ROC Curve                                                  │
    │  ─────────                                                  │
    │    1.0 ┤                                   ●●●●●           │
    │        │                              ●●●●                 │
    │   TPR  │                         ●●●●●                     │
    │        │                    ●●●●●                          │
    │    0.0 ┤●●●●●─────────────────────────────────────        │
    │        └────────────────────────────────────────────       │
    │        0.0                FPR                   1.0         │
    │                                                             │
    │  Diagonal line = random guessing (AUROC = 0.5)             │
    │  Curve above = better than random                          │
    │  AUROC = area under curve                                  │
    └────────────────────────────────────────────────────────────┘
              │
              ▼
    ┌────────────────────────────────────────────────────────────┐
    │  Confidence Distribution                                    │
    │  ──────────────────────                                    │
    │   Frequency                                                 │
    │      ▲                                                      │
    │   10 ┤     ┌──┐                                            │
    │      │     │██│     ┌──┐                                   │
    │    5 ┤  ┌──┤██├──┬──┤██│                                   │
    │      │  │██│██│██│██│██│                                   │
    │    0 ┼──┴──┴──┴──┴──┴──┴───────────────►                  │
    │        0.0  0.5  0.7  0.9  1.0  Confidence                 │
    │                                                             │
    │  Green bars: Correct predictions                           │
    │  Red bars:   Incorrect predictions                         │
    └────────────────────────────────────────────────────────────┘
              │
              ▼
    ┌────────────────────────────────────────────────────────────┐
    │  Risk-Coverage Curve                                        │
    │  ───────────────────                                        │
    │   Risk                                                      │
    │    1.0 ┤●                                                   │
    │        │ ●●                                                 │
    │        │   ●●●                                              │
    │        │      ●●●●●                                         │
    │    0.0 ┤           ●●●●●●●●●●●●●●●●●●●●●●                │
    │        └────────────────────────────────────────────       │
    │        1.0       Coverage (fraction kept)          0.0      │
    │                                                             │
    │  Shows: If we abstain from uncertain predictions,          │
    │         how does error rate change?                        │
    └────────────────────────────────────────────────────────────┘


FINAL OUTPUT: Comprehensive Metrics Report
════════════════════════════════════════════════════════════════════

┌──────────────────────────────────────────────────────────────────┐
│  FESTA EVALUATION METRICS - 2 SAMPLES                            │
│  ════════════════════════════════════════                        │
│                                                                  │
│  Core Metrics:                                                   │
│  ─────────────                                                   │
│    AUROC:         0.78  ✓ (Target: ≥ 0.7)                      │
│    Accuracy:      94.7% (36/38 predictions)                     │
│    Precision:     0.947                                          │
│    Recall:        0.947                                          │
│    F1-Score:      0.947                                          │
│    AUPRC:         0.92                                           │
│    Brier Score:   0.045 (lower is better)                       │
│    ECE:           0.038 (well calibrated)                       │
│                                                                  │
│  FESTA Metrics:                                                  │
│  ──────────────                                                  │
│    FES Consistency:     100% (20/20 samples)                    │
│    FCS Discrimination:  100% (20/20 samples)                    │
│                                                                  │
│  Sample Breakdown:                                               │
│  ─────────────────                                               │
│    Original:     2 samples (100% correct)                       │
│    FES Text:    10 samples (100% consistent)                    │
│    FES Image:   10 samples (100% consistent)                    │
│    FCS Text:    10 samples (100% discriminated)                 │
│    FCS Image:    6 samples (100% discriminated)                 │
│                                                                  │
│  Total Predictions: 38                                           │
│  Total Correct:     36                                           │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════
DIAGRAM 5: CONFIGURATION & SCALABILITY
═══════════════════════════════════════════════════════════════════════════════

ENVIRONMENT VARIABLES (.env file)
══════════════════════════════════════════════════════════════════

    ┌──────────────────────────────────────────────────────────┐
    │  API KEYS (Required)                                      │
    │  ───────────────────                                      │
    │  OPENAI_API_KEY=sk-...                                   │
    │  GOOGLE_API_KEY=AIza...                                  │
    │  HF_TOKEN=hf_...                                          │
    └──────────────────────────────────────────────────────────┘
                            │
                            ▼
    ┌──────────────────────────────────────────────────────────┐
    │  SAMPLE CONFIGURATION                                     │
    │  ────────────────────                                     │
    │  NUM_SAMPLES=2      ← Test run (samples 1-2)            │
    │  SKIP_SAMPLES=0                                          │
    │                                                           │
    │  NUM_SAMPLES=143    ← Full dataset                      │
    │  SKIP_SAMPLES=0                                          │
    │                                                           │
    │  NUM_SAMPLES=50     ← Parallel run 1 (samples 1-50)     │
    │  SKIP_SAMPLES=0                                          │
    │                                                           │
    │  NUM_SAMPLES=50     ← Parallel run 2 (samples 51-100)   │
    │  SKIP_SAMPLES=50                                         │
    │                                                           │
    │  NUM_SAMPLES=43     ← Parallel run 3 (samples 101-143)  │
    │  SKIP_SAMPLES=100                                        │
    └──────────────────────────────────────────────────────────┘
                            │
                            ▼
    ┌──────────────────────────────────────────────────────────┐
    │  FESTA PARAMETERS                                         │
    │  ────────────────                                         │
    │  FES_TEXT_SAMPLES=5    ← Paraphrases per sample         │
    │  FES_IMAGE_SAMPLES=5   ← Visual transforms per sample   │
    │  FCS_TEXT_SAMPLES=5    ← Contradictions per sample      │
    │  FCS_IMAGE_SAMPLES=3   ← Spatial flips per sample       │
    │                                                           │
    │  Total variants per sample: 5+5+5+3 = 18                │
    │  Total predictions per sample: 1 (orig) + 18 = 19       │
    └──────────────────────────────────────────────────────────┘
                            │
                            ▼
    ┌──────────────────────────────────────────────────────────┐
    │  MODEL CONFIGURATION                                      │
    │  ───────────────────                                      │
    │  MODEL_ID_MLLM=llava-hf/llava-v1.6-mistral-7b-hf        │
    │  OPENAI_TEXT_MODEL=gpt-4o-mini                           │
    │  GOOGLE_GEMINI_MODEL=gemini-pro-latest                   │
    │                                                           │
    │  USE_4BIT_QUANTIZATION=true                              │
    │  USE_MIXED_PRECISION=true                                │
    └──────────────────────────────────────────────────────────┘


EXECUTION MODES
══════════════════════════════════════════════════════════════════

    ┌──────────────────────────────────────────────────────────┐
    │  MODE 1: TEST RUN (2 samples)                            │
    │  ─────────────────────────────                           │
    │  $ export NUM_SAMPLES=2                                  │
    │  $ export SKIP_SAMPLES=0                                 │
    │  $ python src/festa_with_apis.py                         │
    │                                                           │
    │  Purpose: Quick validation                               │
    │  Time: ~5-10 minutes                                     │
    │  Output: 2×19 = 38 predictions                          │
    └──────────────────────────────────────────────────────────┘
                            │
                            ▼
    ┌──────────────────────────────────────────────────────────┐
    │  MODE 2: FULL RUN (143 samples)                          │
    │  ──────────────────────────────                          │
    │  $ export NUM_SAMPLES=143                                │
    │  $ export SKIP_SAMPLES=0                                 │
    │  $ python src/festa_with_apis.py                         │
    │                                                           │
    │  Purpose: Complete evaluation                            │
    │  Time: ~8-12 hours (with rate limiting)                 │
    │  Output: 143×19 = 2,717 predictions                     │
    └──────────────────────────────────────────────────────────┘
                            │
                            ▼
    ┌──────────────────────────────────────────────────────────┐
    │  MODE 3: PARALLEL EXECUTION (3 instances)                │
    │  ────────────────────────────────────────                │
    │  # Terminal 1                                            │
    │  $ export NUM_SAMPLES=50 && export SKIP_SAMPLES=0        │
    │  $ python src/festa_with_apis.py                         │
    │                                                           │
    │  # Terminal 2                                            │
    │  $ export NUM_SAMPLES=50 && export SKIP_SAMPLES=50       │
    │  $ python src/festa_with_apis.py                         │
    │                                                           │
    │  # Terminal 3                                            │
    │  $ export NUM_SAMPLES=43 && export SKIP_SAMPLES=100      │
    │  $ python src/festa_with_apis.py                         │
    │                                                           │
    │  Purpose: Faster completion with multiple GPUs           │
    │  Time: ~3-4 hours (parallelized)                        │
    └──────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════
END OF VISUAL DIAGRAMS
═══════════════════════════════════════════════════════════════════════════════

